 /*
  ~ * Copyright (c) 2020, WSO2 Inc. (http://www.wso2.org) All Rights Reserved.
  ~ *
  ~ * Licensed under the Apache License, Version 2.0 (the "License");
  ~ * you may not use this file except in compliance with the License.
  ~ * You may obtain a copy of the License at
  ~ *
  ~ * http://www.apache.org/licenses/LICENSE-2.0
  ~ *
  ~ * Unless required by applicable law or agreed to in writing, software
  ~ * distributed under the License is distributed on an "AS IS" BASIS,
  ~ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  ~ * See the License for the specific language governing permissions and
  ~ * limitations under the License.
  ~ */

import org.apache.tools.ant.filters.*
import org.apache.tools.ant.taskdefs.condition.Os
import groovy.json.JsonSlurper

description = 'Ballerina - Tools'

ext {
    jreLocation="build/target/ballerina-jre-artifacts-zip/ballerina-jre-artifacts-${ballerinaJreArtifactsVersion}"
    distributionName="ballerina"
}

configurations {
    jBallerinaDistribution
    ballerinaDistribution
    ballerinaLinuxDistribution
    ballerinaMacDistribution
    ballerinaWindowsDistribution
}

def jBallerinaDistributionZip = file("$project.buildDir/distributions/ballerina-${shortVersion}.zip")
def ballerinaDistributionZip = file("$project.buildDir/distributions/ballerina-${ballerinaVersion}.zip")
def ballerinaLinuxDistributionZip = file("$project.buildDir/distributions/ballerina-linux-${ballerinaVersion}.zip")
def ballerinaMacDistributionZip = file("$project.buildDir/distributions/ballerina-macos-${ballerinaVersion}.zip")
def ballerinaWindowsDistributionZip = file("$project.buildDir/distributions/ballerina-windows-${ballerinaVersion}.zip")

task unpackBallerinaJre(type: Copy) {
    group = "unpack_dependencies"
    configurations.ballerinaJre.resolvedConfiguration.resolvedArtifacts.each { artifact ->
        from zipTree(artifact.getFile())
        into new File("${buildDir}/target", artifact.name + "-zip")
    }
}

task unpackJballerinaTools(type: Copy) {
    group = "unpack_dependencies"
    configurations.jbalTools.resolvedConfiguration.resolvedArtifacts.each { artifact ->
            from zipTree(artifact.getFile())
            into new File("${buildDir}/target/extracted-distributions", artifact.name+"-zip")
    }
}

task unpackAwsLambdaBalo(type: Copy) {
    group = "unpack_dependencies"
    configurations.awsLambdaBalo.resolvedConfiguration.resolvedArtifacts.each { artifact ->
            from zipTree(artifact.getFile())
            into new File("${buildDir}/target/extracted-distributions", artifact.name+"-zip")
    }
}

task unpackAzFunctionsBalo(type: Copy) {
    group = "unpack_dependencies"
    configurations.azFunctionsBalo.resolvedConfiguration.resolvedArtifacts.each { artifact ->
        from zipTree(artifact.getFile())
        into new File("${buildDir}/target/extracted-distributions", artifact.name + "-zip")
    }
}

task unpackAwsLambdaExamples(type: Copy) {
    group = "unpack_dependencies"
    configurations.awsLambdaExamples.resolvedConfiguration.resolvedArtifacts.each { artifact ->
            from zipTree(artifact.getFile())
            into new File("${buildDir}/target/extracted-distributions", artifact.name+"-zip")
    }
}

task unpackAzFunctionsExamples(type: Copy) {
    group = "unpack_dependencies"
    configurations.azFunctionsExamples.resolvedConfiguration.resolvedArtifacts.each { artifact ->
        from zipTree(artifact.getFile())
        into new File("${buildDir}/target/extracted-distributions", artifact.name+"-zip")
    }
}

task unpackDockerAnnotations(type: Copy) {
    group = "unpack_dependencies"
    configurations.dockerAnnotations.resolvedConfiguration.resolvedArtifacts.each { artifact ->
            from zipTree(artifact.getFile())
            into new File("${buildDir}/target/extracted-distributions", artifact.name+"-zip")
    }
}

task unpackDockerExamples(type: Copy) {
    group = "unpack_dependencies"
    configurations.dockerExamples.resolvedConfiguration.resolvedArtifacts.each { artifact ->
            from zipTree(artifact.getFile())
            into new File("${buildDir}/target/extracted-distributions", artifact.name+"-zip")
    }
}

task unpackKubernetesAnnotations(type: Copy) {
    group = "unpack_dependencies"
    configurations.kubernetesAnnotations.resolvedConfiguration.resolvedArtifacts.each { artifact ->
            from zipTree(artifact.getFile())
            into new File("${buildDir}/target/extracted-distributions", artifact.name+"-zip")
    }
}

task unpackKubernetesExamples(type: Copy) {
    group = "unpack_dependencies"
    configurations.kubernetesExamples.resolvedConfiguration.resolvedArtifacts.each { artifact ->
            from zipTree(artifact.getFile())
            into new File("${buildDir}/target/extracted-distributions", artifact.name+"-zip")
    }
}

task unpackStdLibs() {
    doLast {
        configurations.ballerinaStdLibs.resolvedConfiguration.resolvedArtifacts.each { artifact ->
            copy {
                from project.zipTree(artifact.getFile())
                into new File("${buildDir}/target/extracted-distributions", artifact.name + "-zip")
            }
        }
    }
}

task unpackC2cLibs() {
    doLast {
        configurations.ballerinaC2cLibs.resolvedConfiguration.resolvedArtifacts.each { artifact ->
            copy {
                from project.zipTree(artifact.getFile())
                into new File("${buildDir}/target/extracted-distributions", artifact.name + "-zip")
            }
        }
    }
}

task unpackBalCommand(type: Copy) {
    group = "unpack_dependencies"
    configurations.balCommand.resolvedConfiguration.resolvedArtifacts.each { artifact ->
            from zipTree(artifact.getFile())
            into new File("${buildDir}/target/extracted-distributions", artifact.name+"-zip")
    }
}

task extractJreForLinux(type: Copy) {
    group = "extract_jre"
    from zipTree{"${jreLocation}/jre-11-linux.zip"}
    into("${buildDir}/target/extracted-jre-linux")
}

task extractJreForMac(type: Copy) {
    group = "extract_jre"
    from zipTree{"${jreLocation}/jre-11-macos.zip"}
    into("${buildDir}/target/extracted-jre-macos")
}

task extractJreForWindows(type: Copy) {
    group = "extract_jre"
    from zipTree{"${jreLocation}/jre-11-windows.zip"}
    into("${buildDir}/target/extracted-jre-windows")
}

task deleteTemporaryFiles(type: Delete) {
    delete 'build/target'
}

task copyOtherRepos(type: Copy) {
    def ballerinaDist = "build/target/extracted-distributions/jballerina-tools-zip/jballerina-tools-${ballerinaVersion}"
    into ballerinaDist

    into("docs") {
        from "build/target/extracted-distributions/docker-extension-annotations-zip/docs"
    }

    into("docs") {
        from "build/target/extracted-distributions/kubernetes-extension-annotations-zip/docs"
    }

    into("docs") {
        from "build/target/extracted-distributions/awslambda-extension-balo-zip/docs"
    }

    into("docs") {
        from "build/target/extracted-distributions/azurefunctions-extension-balo-zip/docs"
    }

    /* Standard Libraries */
    configurations.ballerinaStdLibs.resolvedConfiguration.resolvedArtifacts.each { artifact ->
        def artifactExtractedPath = "${buildDir}/target/extracted-distributions/" + artifact.name + "-zip"
        into("bir-cache/") {
            from "${artifactExtractedPath}/caches/bir"
        }
        into("bre/lib/") {
            from "${artifactExtractedPath}/libs"
        }
        into("docs/") {
            from "${artifactExtractedPath}/docs"
        }
        // pack to new cache
        into("cache/bir/") {
            from "${artifactExtractedPath}/caches/bir"
        }
        into("cache/balo/") {
            from "${artifactExtractedPath}/caches/balo"
        }
        into("cache/jar/") {
            from "${artifactExtractedPath}/caches/jar"
        }
    }

    /* C2C Libraries */
    configurations.ballerinaC2cLibs.resolvedConfiguration.resolvedArtifacts.each { artifact ->
        def artifactExtractedPath = "${buildDir}/target/extracted-distributions/" + artifact.name + "-zip"
        into("bre/lib/") {
            from "${artifactExtractedPath}/libs"
        }
        into("docs/") {
            from "${artifactExtractedPath}/docs"
        }
        into("bir-cache/") {
            from "${artifactExtractedPath}/caches/bir"
        }
    }
}

task combineDocs(type: Exec) {
    workingDir "build/target/extracted-distributions/jballerina-tools-zip/jballerina-tools-${ballerinaVersion}/docs"
    if (Os.isFamily(Os.FAMILY_WINDOWS)) {
        commandLine 'cmd', '/c', "$project.buildDir/target/extracted-distributions/jballerina-tools-zip/" +
                "jballerina-tools-${ballerinaVersion}/bin/ballerina.bat", "doc", "--combine"
    } else {
        commandLine "$project.buildDir/target/extracted-distributions/jballerina-tools-zip/" +
                "jballerina-tools-${ballerinaVersion}/bin/ballerina", "doc", "--combine"
    }
}

task packageDist(type: Zip) {
    group = "package_distribution"
    description = 'Ballerina Tools Distribution Assembly'
    baseName = "${distributionName}"
    ext{parentDir="${baseName}-${shortVersion}"}
    archiveFileName="${baseName}-${shortVersion}.zip"
    entryCompression=ZipEntryCompression.STORED

    into("${parentDir}") {
        from "build/target/extracted-distributions/jballerina-tools-zip/jballerina-tools-${ballerinaVersion}"
    }
    into("${parentDir}/examples") {
        from "${project.rootDir}/examples/"
        fileMode = 0755
    }
    into("${parentDir}/examples") {
        from "build/target/extracted-distributions/awslambda-extension-examples-zip"
        exclude "index.js"
    }
    into("${parentDir}/examples") {
        from "build/target/extracted-distributions/azurefunctions-extension-examples-zip"
        exclude "index.js"
    }
    into("${parentDir}/examples") {
        from "build/target/extracted-distributions/docker-extension-examples-zip"
        exclude "index.js"
    }
    into("${parentDir}/examples") {
        from "build/target/extracted-distributions/kubernetes-extension-examples-zip"
        exclude "index.js"
    }
    into("${parentDir}/bir-cache/ballerina/docker") {
        from "build/target/extracted-distributions/docker-extension-annotations-zip/docker"
    }
    into("${parentDir}/bir-cache/ballerina/kubernetes") {
        from "build/target/extracted-distributions/kubernetes-extension-annotations-zip/kubernetes"
    }
    into("${parentDir}/bir-cache/ballerina/istio") {
        from "build/target/extracted-distributions/kubernetes-extension-annotations-zip/istio"
    }
    into("${parentDir}/bir-cache/ballerina/openshift") {
        from "build/target/extracted-distributions/kubernetes-extension-annotations-zip/openshift"
    }
    into("${parentDir}/bir-cache/ballerina/knative") {
        from "build/target/extracted-distributions/kubernetes-extension-annotations-zip/knative"
    }
    into("${parentDir}/bir-cache/ballerinax/awslambda") {
        from "build/target/extracted-distributions/awslambda-extension-balo-zip/awslambda"
    }
    into("${parentDir}/bir-cache/ballerinax/azure.functions") {
        from "build/target/extracted-distributions/azurefunctions-extension-balo-zip/azure.functions"
    }

    /* Files */
    into("${parentDir}/lib/") {
        from "lib/version.txt"
        fileMode = 0644
        filter(ReplaceTokens, tokens: [version: version])
    }
    into("${parentDir}/bre/lib") {
        from "build/target/extracted-distributions/awslambda-extension-balo-zip/ballerinax-awslambda-0.0.0.jar"
        fileMode = 0644
    }
    into("${parentDir}/bre/lib") {
        from "build/target/extracted-distributions/azurefunctions-extension-balo-zip/ballerinax-azure.functions-1.0.0.jar"
        fileMode = 0644
    }
    into("${parentDir}/bre/lib") {
        from "build/target/extracted-distributions/docker-extension-annotations-zip/ballerina-docker-1.0.0.jar"
        fileMode = 0644
    }
    into("${parentDir}/bre/lib") {
        from "build/target/extracted-distributions/kubernetes-extension-annotations-zip/ballerina-kubernetes-1.0.0.jar"
        fileMode = 0644
    }
    into("${parentDir}/bre/lib") {
        from "build/target/extracted-distributions/kubernetes-extension-annotations-zip/ballerina-istio-1.0.0.jar"
        fileMode = 0644
    }
    into("${parentDir}/bre/lib") {
        from "build/target/extracted-distributions/kubernetes-extension-annotations-zip/ballerina-openshift-1.0.0.jar"
        fileMode = 0644
    }
    into("${parentDir}/bre/lib") {
        from "build/target/extracted-distributions/kubernetes-extension-annotations-zip/ballerina-knative-1.0.0.jar"
        fileMode = 0644
    }

    /* Dependencies */
    into("${parentDir}/bre/lib") {
        from configurations.exten
    }

    doLast {
        println 'Ballerina Tools Distribution Packaged'
    }

    outputs.file jBallerinaDistributionZip
}

task packageDistZip(type: Zip) {
    group = "package_distribution"
    description = 'Ballerina Distribution Assembly'
    baseName = "${distributionName}"
    ext{parentDir="${baseName}-${version}"}
    entryCompression=ZipEntryCompression.STORED

    into("${parentDir}") {
        from({ new File(temporaryDir, 'dependencies').mkdirs(); temporaryDir })
    }

    into("${parentDir}/distributions/ballerina-${shortVersion}/examples/") {
        from "${project.rootDir}/examples/"
        fileMode = 0755
    }
    into("${parentDir}/distributions/ballerina-${shortVersion}/examples") {
        from "build/target/extracted-distributions/awslambda-extension-examples-zip"
        exclude "index.js"
    }
    into("${parentDir}/distributions/ballerina-${shortVersion}/examples") {
        from "build/target/extracted-distributions/azurefunctions-extension-examples-zip"
        exclude "index.js"
    }
    into("${parentDir}/distributions/ballerina-${shortVersion}/examples") {
        from "build/target/extracted-distributions/docker-extension-examples-zip"
        exclude "index.js"
    }
    into("${parentDir}/distributions/ballerina-${shortVersion}/examples") {
        from "build/target/extracted-distributions/kubernetes-extension-examples-zip"
        exclude "index.js"
    }
    into("${parentDir}/distributions/ballerina-${shortVersion}/bir-cache/ballerina/docker") {
        from "build/target/extracted-distributions/docker-extension-annotations-zip/docker"
    }
    into("${parentDir}/distributions/ballerina-${shortVersion}/bir-cache/ballerina/kubernetes") {
        from "build/target/extracted-distributions/kubernetes-extension-annotations-zip/kubernetes"
    }
    into("${parentDir}/distributions/ballerina-${shortVersion}/bir-cache/ballerina/istio") {
        from "build/target/extracted-distributions/kubernetes-extension-annotations-zip/istio"
    }
    into("${parentDir}/distributions/ballerina-${shortVersion}/bir-cache/ballerina/openshift") {
        from "build/target/extracted-distributions/kubernetes-extension-annotations-zip/openshift"
    }
    into("${parentDir}/distributions/ballerina-${shortVersion}/bir-cache/ballerina/knative") {
        from "build/target/extracted-distributions/kubernetes-extension-annotations-zip/knative"
    }
    into("${parentDir}/distributions/ballerina-${shortVersion}/bir-cache/ballerinax/awslambda") {
        from "build/target/extracted-distributions/awslambda-extension-balo-zip/awslambda"
    }
    into("${parentDir}/distributions/ballerina-${shortVersion}/bir-cache/ballerinax/azure.functions") {
        from "build/target/extracted-distributions/azurefunctions-extension-balo-zip/azure.functions"
    }

    /* Tools artifacts */
    into("${parentDir}/distributions/ballerina-${shortVersion}") {
        from "build/target/extracted-distributions/jballerina-tools-zip/jballerina-tools-${ballerinaVersion}"
        exclude "distributions/ballerina-version"
        exclude "/bin/version.txt"

    }
    into("${parentDir}") {
        from "../resources/tools"
        exclude "distributions/ballerina-version"
        filter(ReplaceTokens, tokens: [ballerinaCommandVersion: ballerinaCommandVersion])
    }

    /* Files */
    into("${parentDir}/distributions/ballerina-${shortVersion}/bin") {
        from "lib/version.txt"
        fileMode = 0644
        filter(ReplaceTokens, tokens: [version: shortVersion])
    }
    into("${parentDir}/distributions/ballerina-${shortVersion}/bre/lib") {
        from "build/target/extracted-distributions/awslambda-extension-balo-zip/ballerinax-awslambda-0.0.0.jar"
        fileMode = 0644
    }
    into("${parentDir}/distributions/ballerina-${shortVersion}/bre/lib") {
        from "build/target/extracted-distributions/azurefunctions-extension-balo-zip/ballerinax-azure.functions-1.0.0.jar"
        fileMode = 0644
    }
    into("${parentDir}/distributions/ballerina-${shortVersion}/bre/lib") {
        from "build/target/extracted-distributions/docker-extension-annotations-zip/ballerina-docker-1.0.0.jar"
        fileMode = 0644
    }
    into("${parentDir}/distributions/ballerina-${shortVersion}/bre/lib") {
        from "build/target/extracted-distributions/kubernetes-extension-annotations-zip/ballerina-kubernetes-1.0.0.jar"
        fileMode = 0644
    }
    into("${parentDir}/distributions/ballerina-${shortVersion}/bre/lib") {
        from "build/target/extracted-distributions/kubernetes-extension-annotations-zip/ballerina-istio-1.0.0.jar"
        fileMode = 0644
    }
    into("${parentDir}/distributions/ballerina-${shortVersion}/bre/lib") {
        from "build/target/extracted-distributions/kubernetes-extension-annotations-zip/ballerina-openshift-1.0.0.jar"
        fileMode = 0644
    }
    into("${parentDir}/distributions/ballerina-${shortVersion}/bre/lib") {
        from "build/target/extracted-distributions/kubernetes-extension-annotations-zip/ballerina-knative-1.0.0.jar"
        fileMode = 0644
    }

    into("${parentDir}/distributions") {
        from "../resources/tools/distributions/ballerina-version"
        fileMode = 0644
        filter(ReplaceTokens, tokens: [version: shortVersion])
    }
    into("${parentDir}/bin") {
        from "build/target/extracted-distributions/ballerina-command-distribution-zip/bin/ballerina"
        fileMode = 0775
        filter(ReplaceTokens, tokens: [ballerinaCommandVersion: ballerinaCommandVersion])
    }
    into("${parentDir}/bin") {
        from "build/target/extracted-distributions/ballerina-command-distribution-zip/bin/ballerina.bat"
        fileMode = 0775
        filter(ReplaceTokens, tokens: [ballerinaCommandVersion: ballerinaCommandVersion])
    }
    into("${parentDir}/lib") {
        from "build/target/extracted-distributions/ballerina-command-distribution-zip/lib/ballerina-command-${ballerinaCommandVersion}.jar"
        fileMode = 0775
    }

    /* Dependencies */
    into("${parentDir}/distributions/ballerina-${shortVersion}/bre/lib") {
        from configurations.exten
    }

    doLast {
        println 'Ballerina Distribution Packaged'
    }

    outputs.file ballerinaDistributionZip
}

task packageDistLinux(type: Zip) {
    group = "package_distribution"
    description = 'Ballerina Linux Distribution Assembly'
    baseName = "${distributionName}-linux"
    ext{parentDir="${baseName}-${version}"}
    entryCompression=ZipEntryCompression.STORED

    into("${parentDir}/dependencies") {
        from "build/target/extracted-jre-linux"
        fileMode = 0755
    }
    into("${parentDir}/distributions/ballerina-${shortVersion}/examples/") {
        from "${project.rootDir}/examples/"
        fileMode = 0755
    }
    into("${parentDir}/distributions/ballerina-${shortVersion}/examples") {
        from "build/target/extracted-distributions/awslambda-extension-examples-zip"
        exclude "index.js"
    }
    into("${parentDir}/distributions/ballerina-${shortVersion}/examples") {
        from "build/target/extracted-distributions/azurefunctions-extension-examples-zip"
        exclude "index.js"
    }
    into("${parentDir}/distributions/ballerina-${shortVersion}/examples") {
        from "build/target/extracted-distributions/docker-extension-examples-zip"
        exclude "index.js"
    }
    into("${parentDir}/distributions/ballerina-${shortVersion}/examples") {
        from "build/target/extracted-distributions/kubernetes-extension-examples-zip"
        exclude "index.js"
    }
    into("${parentDir}/distributions/ballerina-${shortVersion}/bir-cache/ballerina/docker") {
        from "build/target/extracted-distributions/docker-extension-annotations-zip/docker"
    }
    into("${parentDir}/distributions/ballerina-${shortVersion}/bir-cache/ballerina/kubernetes") {
        from "build/target/extracted-distributions/kubernetes-extension-annotations-zip/kubernetes"
    }
    into("${parentDir}/distributions/ballerina-${shortVersion}/bir-cache/ballerina/istio") {
        from "build/target/extracted-distributions/kubernetes-extension-annotations-zip/istio"
    }
    into("${parentDir}/distributions/ballerina-${shortVersion}/bir-cache/ballerina/openshift") {
        from "build/target/extracted-distributions/kubernetes-extension-annotations-zip/openshift"
    }
    into("${parentDir}/distributions/ballerina-${shortVersion}/bir-cache/ballerina/knative") {
        from "build/target/extracted-distributions/kubernetes-extension-annotations-zip/knative"
    }
    into("${parentDir}/distributions/ballerina-${shortVersion}/bir-cache/ballerinax/awslambda") {
        from "build/target/extracted-distributions/awslambda-extension-balo-zip/awslambda"
    }
    into("${parentDir}/distributions/ballerina-${shortVersion}/bir-cache/ballerinax/azure.functions") {
        from "build/target/extracted-distributions/azurefunctions-extension-balo-zip/azure.functions"
    }

    /* Tools artifacts */
    into("${parentDir}/distributions/ballerina-${shortVersion}") {
        from "build/target/extracted-distributions/jballerina-tools-zip/jballerina-tools-${ballerinaVersion}"
        exclude "distributions/ballerina-version"
        exclude "/bin/ballerina.bat"
        exclude "/bin/version.txt"
    }
    into("${parentDir}") {
        from "../resources/tools"
        exclude "distributions/ballerina-version"
        exclude "**/scripts/**"
    }

    /* Files */
    into("${parentDir}/distributions/ballerina-${shortVersion}/bin") {
        from "lib/version.txt"
        fileMode = 0644
        filter(ReplaceTokens, tokens: [version: version])
    }
    into("${parentDir}/distributions/ballerina-${shortVersion}/bre/lib") {
        from "build/target/extracted-distributions/awslambda-extension-balo-zip/ballerinax-awslambda-0.0.0.jar"
        fileMode = 0644
    }
    into("${parentDir}/distributions/ballerina-${shortVersion}/bre/lib") {
        from "build/target/extracted-distributions/azurefunctions-extension-balo-zip/ballerinax-azure.functions-1.0.0.jar"
        fileMode = 0644
    }
    into("${parentDir}/distributions/ballerina-${shortVersion}/bre/lib") {
        from "build/target/extracted-distributions/docker-extension-annotations-zip/ballerina-docker-1.0.0.jar"
        fileMode = 0644
    }
    into("${parentDir}/distributions/ballerina-${shortVersion}/bre/lib") {
        from "build/target/extracted-distributions/kubernetes-extension-annotations-zip/ballerina-kubernetes-1.0.0.jar"
        fileMode = 0644
    }
    into("${parentDir}/distributions/ballerina-${shortVersion}/bre/lib") {
        from "build/target/extracted-distributions/kubernetes-extension-annotations-zip/ballerina-istio-1.0.0.jar"
        fileMode = 0644
    }
    into("${parentDir}/distributions/ballerina-${shortVersion}/bre/lib") {
        from "build/target/extracted-distributions/kubernetes-extension-annotations-zip/ballerina-openshift-1.0.0.jar"
        fileMode = 0644
    }
    into("${parentDir}/distributions/ballerina-${shortVersion}/bre/lib") {
        from "build/target/extracted-distributions/kubernetes-extension-annotations-zip/ballerina-knative-1.0.0.jar"
        fileMode = 0644
    }

    into("${parentDir}/distributions") {
        from "../resources/tools/distributions/ballerina-version"
        fileMode = 0644
        filter(ReplaceTokens, tokens: [version: shortVersion])
    }
    into("${parentDir}/bin") {
        from "build/target/extracted-distributions/ballerina-command-distribution-zip/bin/ballerina"
        fileMode = 775
        filter(ReplaceTokens, tokens: [ballerinaCommandVersion: ballerinaCommandVersion])
    }
    into("${parentDir}/lib") {
        from "build/target/extracted-distributions/ballerina-command-distribution-zip/lib/ballerina-command-${ballerinaCommandVersion}.jar"
        fileMode = 0775
    }

    /* Dependencies */
    into("${parentDir}/distributions/ballerina-${shortVersion}/bre/lib"){
        from configurations.exten
    }

    doLast{
        println 'Ballerina Linux Distribution Packaged'
    }

    outputs.file ballerinaLinuxDistributionZip
}

task packageDistMac(type: Zip) {
    group = "package_distribution"
    description = 'Ballerina MacOS Distribution Assembly'
    baseName = "${distributionName}-macos"
    ext{parentDir="${baseName}-${version}"}
    entryCompression=ZipEntryCompression.STORED

    into("${parentDir}/dependencies") {
        from "build/target/extracted-jre-macos"
        fileMode = 0755
    }
    into("${parentDir}/distributions/ballerina-${shortVersion}/examples/") {
        from "${project.rootDir}/examples/"
        fileMode = 0755
    }
    into("${parentDir}/distributions/ballerina-${shortVersion}/examples") {
        from "build/target/extracted-distributions/awslambda-extension-examples-zip"
        exclude "index.js"
    }
    into("${parentDir}/distributions/ballerina-${shortVersion}/examples") {
        from "build/target/extracted-distributions/azurefunctions-extension-examples-zip"
        exclude "index.js"
    }
    into("${parentDir}/distributions/ballerina-${shortVersion}/examples") {
        from "build/target/extracted-distributions/docker-extension-examples-zip"
        exclude "index.js"
    }
    into("${parentDir}/distributions/ballerina-${shortVersion}/examples") {
        from "build/target/extracted-distributions/kubernetes-extension-examples-zip"
        exclude "index.js"
    }
    into("${parentDir}/distributions/ballerina-${shortVersion}/bir-cache/ballerina/docker") {
        from "build/target/extracted-distributions/docker-extension-annotations-zip/docker"
    }
    into("${parentDir}/distributions/ballerina-${shortVersion}/bir-cache/ballerina/kubernetes") {
        from "build/target/extracted-distributions/kubernetes-extension-annotations-zip/kubernetes"
    }
    into("${parentDir}/distributions/ballerina-${shortVersion}/bir-cache/ballerina/istio") {
        from "build/target/extracted-distributions/kubernetes-extension-annotations-zip/istio"
    }
    into("${parentDir}/distributions/ballerina-${shortVersion}/bir-cache/ballerina/openshift") {
        from "build/target/extracted-distributions/kubernetes-extension-annotations-zip/openshift"
    }
    into("${parentDir}/distributions/ballerina-${shortVersion}/bir-cache/ballerina/knative") {
        from "build/target/extracted-distributions/kubernetes-extension-annotations-zip/knative"
    }
    into("${parentDir}/distributions/ballerina-${shortVersion}/bir-cache/ballerinax/awslambda") {
        from "build/target/extracted-distributions/awslambda-extension-balo-zip/awslambda"
    }
    into("${parentDir}/distributions/ballerina-${shortVersion}/bir-cache/ballerinax/azure.functions") {
        from "build/target/extracted-distributions/azurefunctions-extension-balo-zip/azure.functions"
    }

    /* Tools artifacts */
    into("${parentDir}/distributions/ballerina-${shortVersion}") {
        from "build/target/extracted-distributions/jballerina-tools-zip/jballerina-tools-${ballerinaVersion}"
        exclude "distributions/ballerina-version"
        exclude "/bin/ballerina.bat"
        exclude "/bin/version.txt"
    }

    /* Files */
    into("${parentDir}/distributions/ballerina-${shortVersion}/bin") {
        from "lib/version.txt"
        fileMode = 0644
        filter(ReplaceTokens, tokens: [version: version])
    }
    into("${parentDir}/distributions/ballerina-${shortVersion}/bre/lib") {
        from "build/target/extracted-distributions/awslambda-extension-balo-zip/ballerinax-awslambda-0.0.0.jar"
        fileMode = 0644
    }
    into("${parentDir}/distributions/ballerina-${shortVersion}/bre/lib") {
        from "build/target/extracted-distributions/azurefunctions-extension-balo-zip/ballerinax-azure.functions-1.0.0.jar"
        fileMode = 0644
    }
    into("${parentDir}/distributions/ballerina-${shortVersion}/bre/lib") {
        from "build/target/extracted-distributions/docker-extension-annotations-zip/ballerina-docker-1.0.0.jar"
        fileMode = 0644
    }
    into("${parentDir}/distributions/ballerina-${shortVersion}/bre/lib") {
        from "build/target/extracted-distributions/kubernetes-extension-annotations-zip/ballerina-kubernetes-1.0.0.jar"
        fileMode = 0644
    }
    into("${parentDir}/distributions/ballerina-${shortVersion}/bre/lib") {
        from "build/target/extracted-distributions/kubernetes-extension-annotations-zip/ballerina-istio-1.0.0.jar"
        fileMode = 0644
    }
    into("${parentDir}/distributions/ballerina-${shortVersion}/bre/lib") {
        from "build/target/extracted-distributions/kubernetes-extension-annotations-zip/ballerina-openshift-1.0.0.jar"
        fileMode = 0644
    }
    into("${parentDir}/distributions/ballerina-${shortVersion}/bre/lib") {
        from "build/target/extracted-distributions/kubernetes-extension-annotations-zip/ballerina-knative-1.0.0.jar"
        fileMode = 0644
    }

    into("${parentDir}/distributions") {
        from "../resources/tools/distributions/ballerina-version"
        fileMode = 0644
        filter(ReplaceTokens, tokens: [version: shortVersion])
    }
    into("${parentDir}/bin") {
        from "build/target/extracted-distributions/ballerina-command-distribution-zip/bin/ballerina"
        fileMode = 775
        filter(ReplaceTokens, tokens: [ballerinaCommandVersion: ballerinaCommandVersion])
    }
    into("${parentDir}/lib") {
        from "build/target/extracted-distributions/ballerina-command-distribution-zip/lib/ballerina-command-${ballerinaCommandVersion}.jar"
        fileMode = 0775
    }

    /* Dependencies */
    into("${parentDir}/distributions/ballerina-${shortVersion}/bre/lib"){
        from configurations.exten
    }

    doLast{
        println 'Ballerina MacOS Distribution Packaged'
    }

    outputs.file ballerinaMacDistributionZip
}

task packageDistWindows(type: Zip) {
    group = "package_distribution"
    description = 'Ballerina Windows Distribution Assembly'
    baseName = "${distributionName}-windows"
    ext{parentDir="${baseName}-${version}"}
    entryCompression=ZipEntryCompression.STORED

    into("${parentDir}/dependencies") {
        from "build/target/extracted-jre-windows"
        fileMode = 0755
    }
    into("${parentDir}/distributions/ballerina-${shortVersion}/examples/") {
        from "${project.rootDir}/examples/"
        fileMode = 0755
    }
    into("${parentDir}/distributions/ballerina-${shortVersion}/examples") {
        from "build/target/extracted-distributions/awslambda-extension-examples-zip"
        exclude "index.js"
    }
    into("${parentDir}/distributions/ballerina-${shortVersion}/examples") {
        from "build/target/extracted-distributions/azurefunctions-extension-examples-zip"
        exclude "index.js"
    }
    into("${parentDir}/distributions/ballerina-${shortVersion}/examples") {
        from "build/target/extracted-distributions/docker-extension-examples-zip"
        exclude "index.js"
    }
    into("${parentDir}/distributions/ballerina-${shortVersion}/examples") {
        from "build/target/extracted-distributions/kubernetes-extension-examples-zip"
        exclude "index.js"
    }
    into("${parentDir}/distributions/ballerina-${shortVersion}/bir-cache/ballerina/docker") {
        from "build/target/extracted-distributions/docker-extension-annotations-zip/docker"
    }
    into("${parentDir}/distributions/ballerina-${shortVersion}/bir-cache/ballerina/kubernetes") {
        from "build/target/extracted-distributions/kubernetes-extension-annotations-zip/kubernetes"
    }
    into("${parentDir}/distributions/ballerina-${shortVersion}/bir-cache/ballerina/istio") {
        from "build/target/extracted-distributions/kubernetes-extension-annotations-zip/istio"
    }
    into("${parentDir}/distributions/ballerina-${shortVersion}/bir-cache/ballerina/openshift") {
        from "build/target/extracted-distributions/kubernetes-extension-annotations-zip/openshift"
    }
    into("${parentDir}/distributions/ballerina-${shortVersion}/bir-cache/ballerina/knative") {
        from "build/target/extracted-distributions/kubernetes-extension-annotations-zip/knative"
    }
    into("${parentDir}/distributions/ballerina-${shortVersion}/bir-cache/ballerinax/awslambda") {
        from "build/target/extracted-distributions/awslambda-extension-balo-zip/awslambda"
    }
    into("${parentDir}/distributions/ballerina-${shortVersion}/bir-cache/ballerinax/azure.functions") {
        from "build/target/extracted-distributions/azurefunctions-extension-balo-zip/azure.functions"
    }

    /* Tools artifacts */
    into("${parentDir}/distributions/ballerina-${shortVersion}") {
        from "build/target/extracted-distributions/jballerina-tools-zip/jballerina-tools-${ballerinaVersion}"
        exclude "distributions/ballerina-version"
        exclude "/bin/ballerina"
        exclude "/bin/version.txt"
    }

    /* Files */
    into("${parentDir}/distributions/ballerina-${shortVersion}/bin") {
        from "lib/version.txt"
        fileMode = 0644
        filter(ReplaceTokens, tokens: [version: version])
    }
    into("${parentDir}/distributions/ballerina-${shortVersion}/bre/lib") {
        from "build/target/extracted-distributions/awslambda-extension-balo-zip/ballerinax-awslambda-0.0.0.jar"
        fileMode = 0644
    }
    into("${parentDir}/distributions/ballerina-${shortVersion}/bre/lib") {
        from "build/target/extracted-distributions/azurefunctions-extension-balo-zip/ballerinax-azure.functions-1.0.0.jar"
        fileMode = 0644
    }
    into("${parentDir}/distributions/ballerina-${shortVersion}/bre/lib") {
        from "build/target/extracted-distributions/docker-extension-annotations-zip/ballerina-docker-1.0.0.jar"
        fileMode = 0644
    }
    into("${parentDir}/distributions/ballerina-${shortVersion}/bre/lib") {
        from "build/target/extracted-distributions/kubernetes-extension-annotations-zip/ballerina-kubernetes-1.0.0.jar"
        fileMode = 0644
    }
    into("${parentDir}/distributions/ballerina-${shortVersion}/bre/lib") {
        from "build/target/extracted-distributions/kubernetes-extension-annotations-zip/ballerina-istio-1.0.0.jar"
        fileMode = 0644
    }
    into("${parentDir}/distributions/ballerina-${shortVersion}/bre/lib") {
        from "build/target/extracted-distributions/kubernetes-extension-annotations-zip/ballerina-openshift-1.0.0.jar"
        fileMode = 0644
    }
    into("${parentDir}/distributions/ballerina-${shortVersion}/bre/lib") {
        from "build/target/extracted-distributions/kubernetes-extension-annotations-zip/ballerina-knative-1.0.0.jar"
        fileMode = 0644
    }

    into("${parentDir}/distributions") {
        from "../resources/tools/distributions/ballerina-version"
        fileMode = 0644
        filter(ReplaceTokens, tokens: [version: shortVersion])
    }
    into("${parentDir}/bin") {
        from "build/target/extracted-distributions/ballerina-command-distribution-zip/bin/ballerina.bat"
        fileMode = 775
        filter(ReplaceTokens, tokens: [ballerinaCommandVersion: ballerinaCommandVersion])
    }
    into("${parentDir}/lib") {
        from "build/target/extracted-distributions/ballerina-command-distribution-zip/lib/ballerina-command-${ballerinaCommandVersion}.jar"
        fileMode = 0775
    }

    /* Dependencies */
    into("${parentDir}/distributions/ballerina-${shortVersion}/bre/lib"){
        from configurations.exten
    }

    doLast{
        println 'Ballerina Windows Distribution Packaged'
    }

    outputs.file ballerinaWindowsDistributionZip
}

artifacts {
    jBallerinaDistribution file: jBallerinaDistributionZip, builtBy: packageDist
    ballerinaDistribution file: ballerinaDistributionZip, builtBy: packageDistZip
    ballerinaLinuxDistribution file: ballerinaLinuxDistributionZip, builtBy: packageDistLinux
    ballerinaMacDistribution file: ballerinaMacDistributionZip, builtBy: packageDistMac
    ballerinaWindowsDistribution file: ballerinaWindowsDistributionZip, builtBy: packageDistWindows
}

task testExamples() {
    def jBallerinaPack = "${project.rootDir}/ballerina/build/target/extracted-distributions/jballerina-tools-zip"
    def baseBuildPath = "${project.rootDir}/ballerina/build/bbe-pack"
    def distPath = "${baseBuildPath}/jballerina-tools-${ballerinaVersion}"
    def bbeList = []

    PatternSet patternSet = new PatternSet();
    patternSet.exclude("**/.ballerina/**");
    patternSet.exclude("**/Ballerina.toml");
    patternSet.exclude("**/Ballerina.lock");
    patternSet.exclude("**/ballerina-internal.log")
    inputs.files(files("${distPath}/examples").asFileTree.matching(patternSet))

    // The following BBEs will not be verified by compiling/running.
    def buildIgnoreList = [
        'proto-to-ballerina',
        'websub-hub-client-sample',
        'websub-remote-hub-sample',
        'docker-deployment',
        'kubernetes-deployment',
        'knative-deployment',
        'aws-lambda-deployment',
        'azure-functions-deployment',
        'openshift-deployment',
        'grpc-server-streaming',
        'grpc-secured-unary',
        'grpc-bidirectional-streaming',
        'grpc-client-streaming',
        'grpc-unary-non-blocking',
        'grpc-unary-blocking',
        'testerina-guarantee-test-execution-order',
        'testerina-data-driven-tests',
        'testerina-before-and-after-suite',
        'testerina-before-each-test',
        'testerina-before-and-after-test',
        'testerina-assertions',
        'testerina-before-and-after-each',
        'testerina-before-and-after-groups',
        'testerina-group-tests',
        'testerina-mocking-objects',
        'testerina-mocking-functions',
        'http-caching-client',
        'http-data-binding',
        'http-1.1-to-2.0-protocol-switch',
        'basic-https-listener-client',
        'https-listener',
        'http-client-endpoint',
        'response-with-multiparts',
        'mutual-ssl',
        'gauge-metrics',
        'counter-metrics',
        'tracing',
        'openapi-to-ballerina',
        'taint-checking', // Should not compile
        'websub-service-integration-sample',
        'websub-internal-hub-sample',
        'task-service-appointment',
        'task-scheduler-appointment',
        'user-defined-error'
    ]

    // The following BBEs will be excluded from output verification, which means verifying the output of the `.bal` file
    // against the output given at `.out` file. But will be verified by compiling and running tests if it is not added
    // to the above buildIgnoreList.
    def outputVerificationIgnoreList = [
        'the-main-function', //Needs user input
        'local-transactions',  // Xid varies
        'local-transactions-with-handlers', // Xid varies
        'retry-transactions', // Xid varies
        'optional-type',  // Needs inputs at runtime
        'while',        // Needs inputs at runtime
        'any-type', // Has time component
        'record-readonly-fields', // Has user name in output
        'checkpanic', // Has user name in output
        'deprecation', // Contains user input
        'foreach', // Has tabs for formatting in input
        'config-api',
        'kafka-consumer-client',
        'kafka-producer',
        'kafka-consumer-service',
        'kafka-producer-transactional',
        'kafka-consumer-group-service',
        'kafka-authentication-sasl-plain-consumer',
        'kafka-authentication-sasl-plain-producer', // Kafka BBEs are ignored since a KafkaCluster is not present
        'websub-service-integration-sample',
        'websub-internal-hub-sample',
        'grpc-server-streaming',
        'nats-basic-client',
        'nats-streaming-client',
        'nats-streaming-consumer-with-data-binding',
        'nats-streaming-durable-subscriptions',
        'nats-streaming-queue-group',
        'nats-streaming-start-position',
        'http-to-websocket-upgrade',
        'http-compression',
        'http-redirects',
        'http-2-0-server-push',
        'http-cookies',
        'header-based-routing',
        'http-circuit-breaker',
        'request-with-multiparts',
        'different-payload-types',
        'base-path-and-path',
        'http-trace-logs',
        'restrict-by-media-type',
        'http-cors',
        'http-client-data-binding',
        'websocket-basic-sample',
        'websocket-chat-application',
        'websocket-client',
        'websocket-cookie',
        'websocket-failover',
        'websocket-proxy-server',
        'websocket-retry',
        'rabbitmq-producer',
        'rabbitmq-consumer',
        'rabbitmq-consumer-with-client-acknowledgement',
        'rabbitmq-consumer-with-data-binding',
        'rabbitmq-consumer-with-qos-settings',
        'rabbitmq-transaction-producer',
        'rabbitmq-transaction-consumer',
        'jdbc-complex-type-queries', // Consists date time in output
        'log-api',
        'mysql-init-options',
        'mysql-query-operation',
        'mysql-complex-type-queries',
        'mysql-execute-operation',
        'mysql-batch-execute-operation',
        'mysql-parameterized-query',
        'mysql-call-stored-procedures',
        'udp-socket-client',
        'tcp-socket-listener-client',
        'ballerina-to-openapi',
        'client-generation',
        'directory-listener',
        'file', // Absolute path varies
        'filepath', // Depends on OS
        'time',
        'locks', // Output is inconsistent between runs
        'crypto', // Output with line breaks cannot be compared
        'jwt-issue-validate', // Output depends on time
        'secured-client-with-basic-auth', // Need to run the service first
        'secured-client-with-jwt-auth', // Need to run the service first
        'secured-client-with-oauth2', // Need to run the service first
        'send-and-receive-emails',
        'task-service-timer',
        'task-service-appointment',
        'task-scheduler-timer',
        'task-scheduler-appointment',
        'cache'
    ]

    doFirst {
        copy {
            from jBallerinaPack
            into baseBuildPath
        }
        exec {
            //Initialize Ballerina project
            if (Os.isFamily(Os.FAMILY_WINDOWS)) {
                //TODO: Need to verify with windows
                workingDir "${baseBuildPath}"
                commandLine 'cmd', '/c', "jballerina-tools-${ballerinaVersion}/bin/ballerina.bat", 'new', 'TestProject'
            } else {
                workingDir "${baseBuildPath}"
                commandLine 'sh', '-c', "jballerina-tools-${ballerinaVersion}/bin/ballerina new TestProject"
            }
        }

        def src = "${project.rootDir}/examples/"
        def dis = "${baseBuildPath}/TestProject/src/"
        copy {
            from(src)
            into dis
        }
        def inputFile = new File("${baseBuildPath}/TestProject/src/index.json")
        def categories = new JsonSlurper().parseText(inputFile.text)
        categories.each { category ->
            def examples = category.samples
            examples.each { example ->
                def folder = new File("${baseBuildPath}/TestProject/src/${example.url}")
                if (folder.exists()) {
                    bbeList.push("$example.url")
                }
            }
        }
    }

    ext.buildBBE = { bbe ->
        def exitVal
        def additionalBuildParams = ""
        if (bbe == "secured-service-with-basic-auth" || bbe == "secured-client-with-basic-auth") {
            additionalBuildParams = "--b7a.config.file=${baseBuildPath}/TestProject/src/${bbe}/sample-users.toml"
        }
        if (Os.isFamily(Os.FAMILY_WINDOWS)) {
            //TODO: Need to verify with windows
            exitVal = exec {
                ignoreExitValue true
                workingDir "${buildDir}/TestProject"
                commandLine 'cmd', '/c', "${distPath}/bin/ballerina.bat", 'build', '--experimental', "${bbe} --b7a.home=${distPath} ${additionalBuildParams}"
            }
        } else {
            exitVal = exec {
                ignoreExitValue true
                workingDir "${baseBuildPath}/TestProject"
                commandLine 'sh', '-c', "${distPath}/bin/ballerina build --experimental ${bbe} --b7a.home=${distPath} ${additionalBuildParams}"
            }
        }
        if (exitVal.getExitValue() == 1) {
            return true;
        }
        return false;
    }

    ext.outputVerification = { bbe ->
        def directoryPath = "${baseBuildPath}/TestProject/src/${bbe}"
        File fileReference
        def curlCommands = []
        def ports = []
        def fileOut = []
        def balName = bbe.replace('-', '_') + ".bal"
        FileTree tree = fileTree(directoryPath)
        def curlCommandsFilePath = "${directoryPath}/curlcommandout.txt"
        def portFilePath = "${directoryPath}/ports.txt"
        def outputFilePath = "${directoryPath}/output.txt"
        def additionalBuildParams = ""
        if (bbe == "secured-service-with-basic-auth" || bbe == "secured-client-with-basic-auth") {
            additionalBuildParams = "--b7a.config.file=${baseBuildPath}/TestProject/src/${bbe}/sample-users.toml"
        }
        tree.each { content ->
            if (content.name.contains("client.out")) {
                fileReference = file(content)
                fileReference.readLines().each { lines ->
                    fileOut.add(lines.trim())
                    if (lines.startsWith("curl")) {
                        lines = lines.trim() + " >> output.txt"
                        curlCommands.add(lines)
                        if (Os.isFamily(Os.FAMILY_WINDOWS)) {
                            curlCommands.add("echo. >> output.txt")
                        } else {
                            curlCommands.add("echo >> output.txt")
                        }
                    }
                }
            } else if (content.name.contains("server.out") || content.name.contains("service.out")) {
                fileReference = file(content)
                String portPrefix = "[ballerina/http] started HTTP/WS listener 0.0.0.0:"
                fileReference.readLines().each { lines ->
                    if (lines.contains(portPrefix)) {
                        lines = (lines - portPrefix).trim()
                        ports.add(lines)
                    }
                }
            }
        }
        def failFlag = false
        if (!ports.isEmpty() && !curlCommands.isEmpty()) {
            fileReference = new File(portFilePath)
            ports.each {
                fileReference << "${it}\n"
            }
            fileReference = new File(curlCommandsFilePath)
            curlCommands.each {
                fileReference << "${it}\n"
            }
            def scriptPath = "${project.rootDir}/ballerina/lib"
            def exitVal
            if (Os.isFamily(Os.FAMILY_WINDOWS)) {
                exitVal = exec {
                    def windowsPath = scriptPath.replace('/', '\\')
                    workingDir "$windowsPath"
                    commandLine "$windowsPath\\run.bat", "${directoryPath}", "${distPath}/bin/ballerina.bat", "${balName}", "${curlCommandsFilePath}", "${portFilePath}", "--b7a.home=${distPath} ${additionalBuildParams}"
                    ignoreExitValue true
                }
            } else {
                exitVal = exec {
                    workingDir "$scriptPath"
                    commandLine "bash", "run.sh", "${directoryPath}", "${distPath}/bin/./ballerina", "${balName}", "${curlCommandsFilePath}", "${portFilePath}", "--b7a.home=${distPath} ${additionalBuildParams}"
                    ignoreExitValue true
                }
            }
            // Return immediately if command failed
            if (exitVal.getExitValue() == 1) {
                println "Failed due to build failure."
                return true;
            }
            File bbeOutput = new File(outputFilePath)
            if (bbeOutput.exists()) {
                bbeOutput.readLines().each {
                    if (!fileOut.contains(it.trim()) && it) {
                        println "Failed due to output did not match. Line ${it}"
                        failFlag = true
                    }
                }
            }
            delete portFilePath
            delete curlCommandsFilePath
            delete outputFilePath
        } else if (ports.isEmpty() && curlCommands.isEmpty()) {
            balName = bbe.replace('-', '_')
            def str = ""
            fileOut = []
            def bbeOutput = []
            def cmdOutAry = []
            def errOut = new ByteArrayOutputStream()
            new ByteArrayOutputStream().withStream { os ->
                if (Os.isFamily(Os.FAMILY_WINDOWS)) {
                    exec {
                        workingDir "${directoryPath}"
                        commandLine 'cmd', '/c', "${distPath}/bin/ballerina.bat", 'run', '--experimental', "${balName}.bal", "--b7a.home=${distPath} ${additionalBuildParams}"
                        ignoreExitValue true
                        standardOutput = os
                        errorOutput = errOut
                    }
                } else {
                    exec {
                        workingDir "${directoryPath}"
                        commandLine 'sh', '-c', "${distPath}/bin/ballerina run --experimental ${balName}.bal --b7a.home=${distPath} ${additionalBuildParams}"
                        ignoreExitValue true
                        standardOutput = os
                        errorOutput = errOut
                    }
                }
                cmdOutAry.add(os.toString())
                cmdOutAry.add(errOut.toString())
            }
            
            File file = file("${directoryPath}/${balName}.out")
            file.readLines().each {
                str = it.trim()
                if (str?.trim()) {
                    if (str[0] != '#') {
                        fileOut.add(str)
                    }
                }
            }

            def lines = "${cmdOutAry[0]}".split('\n')
            lines = lines + "${cmdOutAry[1]}".split('\n')
            lines.each {
                str = it.trim()
                if (str != "Compiling source" && str != "${balName}.bal" && str != "Running executables" && str != ""
                        && str != "Picked up JAVA_TOOL_OPTIONS: -Dfile.encoding=UTF8") {
                    bbeOutput.add(str)
                }
            }

            for (int i = 0; i < bbeOutput.size(); i++) {
                def index = fileOut.findIndexOf { it == bbeOutput[i] }
                if (index == -1) {
                    println "Failed due to output did not match. Line ${i}: ${bbeOutput[i]}"
                    failFlag = true;
                }
            }
        }
        return failFlag
    }

    doLast {
        buildIgnoreList.each { String elements ->
            bbeList.remove("$elements")
        }
        def failedBuildExamples = []
        def failOutputVerificationExamples = []
        bbeList.each { String bbe ->
            boolean buildFailFlag = buildBBE(bbe)
            if (buildFailFlag) {
                failedBuildExamples.add(bbe)
            }
            if (!outputVerificationIgnoreList.contains(bbe)) {
                boolean outputVerificationFailFlag = outputVerification(bbe)
                if (outputVerificationFailFlag) {
                    failOutputVerificationExamples.add(bbe)
                }
            }
        }
        
        boolean buildFailure = false
        if (!failedBuildExamples.isEmpty()) {
            println "\n\tThe following BBEs failed while building:\n"
            failedBuildExamples.each {
                println "\t ${it}"
            }
            sleep(10 * 1000)
            buildFailure = true
        }

        if (!failOutputVerificationExamples.isEmpty()) {
            println "\n\tThe following BBEs failed while verifying the output:\n"
            failOutputVerificationExamples.each {
                println "\t ${it}"
            }
            sleep(10 * 1000)
            buildFailure = true
        }
        if (buildFailure) {
            sleep(10 * 1000)
            throw new GradleException('There are test failures')
        }
    }
}

task testStdlibs() {
     def jBallerinaPack = "${project.rootDir}/ballerina/build/target/extracted-distributions/jballerina-tools-zip"
     def baseBuildPath = "${project.rootDir}/ballerina/build/bbe-pack"
     def distPath = "${baseBuildPath}/jballerina-tools-${ballerinaVersion}"
     def stdlibTestsList = []

     PatternSet patternSet = new PatternSet();
     patternSet.exclude("**/.ballerina/**");
     patternSet.exclude("**/Ballerina.toml");
     patternSet.exclude("**/Ballerina.lock");
     patternSet.exclude("**/ballerina-internal.log")
     inputs.files(files("${distPath}/stdlib-integration-tests").asFileTree.matching(patternSet))
     def ignoreList = []

     doFirst {
         copy {
             from jBallerinaPack
             into baseBuildPath
         }
         exec {
             //Initialize Ballerina project
             if (Os.isFamily(Os.FAMILY_WINDOWS)) {
                 workingDir "${baseBuildPath}"
                 commandLine 'cmd', '/c', "jballerina-tools-${ballerinaVersion}/bin/ballerina.bat", 'new', 'StdlibTestProject'
             } else {
                 workingDir "${baseBuildPath}"
                 commandLine 'sh', '-c', "jballerina-tools-${ballerinaVersion}/bin/ballerina new StdlibTestProject"
             }
         }

         def src = "${project.rootDir}/stdlib-integration-tests/"
         def dis = "${baseBuildPath}/StdlibTestProject/src/"
         copy {
             from(src)
             into dis
         }
         def inputFile = new File("${baseBuildPath}/StdlibTestProject/src/index.json")
         def stdlibTests = new JsonSlurper().parseText(inputFile.text)
         stdlibTests.each { stdlibTest ->
             def folder = new File("${baseBuildPath}/StdlibTestProject/src/${stdlibTest.path}")
             if (folder.exists()) {
                 stdlibTestsList.push("$stdlibTest.path")
             }

         }
     }

    doLast {
         ignoreList.each { String elements ->
             stdlibTestsList.remove("$elements")
         }
         stdlibTestsList.each { String stdlibTest ->
             def additionalBuildParams = ""
             if (stdlibTest == "auth" || stdlibTest == "jwt") {
                 additionalBuildParams = "--b7a.config.file=${baseBuildPath}/StdlibTestProject/src/${stdlibTest}/tests/resources/datafiles/users.toml"
             }
             
             if (stdlibTest == "config") {
                additionalBuildParams = "--user.name=ballerina-user"
             }

             if (Os.isFamily(Os.FAMILY_WINDOWS)) {
                 //TODO: Need to verify with windows
                 exec {
                     workingDir "${buildDir}/StdlibTestProject"
                     commandLine 'cmd', '/c', "${distPath}/bin/ballerina.bat build -c --experimental ${stdlibTest} --b7a.home=${distPath} ${additionalBuildParams}"
                 }
             } else {
                 exec {
                     workingDir "${baseBuildPath}/StdlibTestProject"
                     commandLine 'sh', '-c', "${distPath}/bin/ballerina build -c --experimental ${stdlibTest} --b7a.home=${distPath} ${additionalBuildParams}"
                 }
             }
         }
     }
}

task testDevTools() {
    def jBallerinaPack = "${project.rootDir}/ballerina/build/target/extracted-distributions/jballerina-tools-zip"
    def baseBuildPath = "${project.rootDir}/ballerina/build/bbe-pack"
    def distPath = "${baseBuildPath}/jballerina-tools-${ballerinaVersion}"
    def devtoolsProjectList = []

    PatternSet patternSet = new PatternSet();
    patternSet.exclude("**/.ballerina/**");
    patternSet.exclude("**/Ballerina.toml");
    patternSet.exclude("**/Ballerina.lock");
    patternSet.exclude("**/ballerina-internal.log")

    inputs.files(files("${distPath}/devtools-integration-tests").asFileTree.matching(patternSet))

    doFirst {
        // Copy compiled pack to baseBuild temp directory
        copy {
            from jBallerinaPack
            into baseBuildPath
        }
        
        // Copy projects to baseBuildPath
        def devToolsProjectSrc = "${project.rootDir}/devtools-integration-tests/"
        copy {
            from(devToolsProjectSrc)
            into baseBuildPath
        }

        // Read the projects from the index.json
        def inputFile = new File("${baseBuildPath}/index.json")
        def devtoolsProjects = new JsonSlurper().parseText(inputFile.text)
        
        // For each project in the devtools integration tests folder, we add it to the project list
        devtoolsProjects.each { devtoolsProject ->
            def folder = new File("${baseBuildPath}/${devtoolsProject.path}")
            if (folder.exists()) {
                devtoolsProjectList.push("$devtoolsProject.path")
            }
        }
    }

    doLast {
        // For each devtools project in the list
        devtoolsProjectList.each { String devtoolsProject ->
            
            // Read the modules from the index.json
            def inputFile = new File("${baseBuildPath}/${devtoolsProject}/index.json")
            def projectModules = new JsonSlurper().parseText(inputFile.text)

            // If module exists, add it to the projectModuleList
            def projectModuleList = []
            projectModules.each { projectModule -> 
                def folder = new File("${baseBuildPath}/${devtoolsProject}/src/${projectModule.path}")
                if (folder.exists()) {
                    projectModuleList.push("$projectModule.path")
                }
            }

            // For each module we execute the `test -c ${projectModule} command
            projectModuleList.each { String projectModule -> 
            
                def additionalBuildParams = ""

                if (Os.isFamily(Os.FAMILY_WINDOWS)) {
                    exec {
                        workingDir "${buildDir}/${devtoolsProject}"
                        commandLine 'cmd', '/c', 
                        "${distPath}/bin/ballerina.bat test ${projectModule} --b7a.home=${distPath} ${additionalBuildParams}"
                    }
                } else {
                    exec {
                        workingDir "${baseBuildPath}/${devtoolsProject}"
                        commandLine 'sh', '-c', 
                        "${distPath}/bin/ballerina test ${projectModule} --b7a.home=${distPath} ${additionalBuildParams}"
                    }
                }
            }
            
        }
    }
}

task startLdapServer() {
    doLast {
        if (!Os.isFamily(Os.FAMILY_WINDOWS)) {
            def stdOut = new ByteArrayOutputStream()
            exec {
                commandLine 'sh', '-c', "docker ps --filter name=openldap-server"
                standardOutput = stdOut
            }
            if (!stdOut.toString().contains("openldap-server")) {
                println "Starting LDAP server."
                copy {
                    from file("$project.rootDir/stdlib-integration-tests/ldap/tests/resources/openldap")
                    into file("/tmp")
                }
                exec {
                    commandLine 'sh', '-c', "docker run --rm -d -p 389:389 --name openldap-server --env LDAP_ORGANISATION=\"AVIX\" --env LDAP_DOMAIN=\"avix.lk\" --env LDAP_ADMIN_PASSWORD=\"avix123\" --env LDAP_BASE_DN=\"dc=avix,dc=lk\" --volume /tmp/bootstrap.ldif:/container/service/slapd/assets/config/bootstrap/ldif/custom/bootstrap.ldif osixia/openldap:1.3.0 --copy-service"
                    standardOutput = stdOut
                }
                println stdOut.toString()
                println "Waiting 15s until the LDAP server get initiated."
                sleep(15 * 1000)
            } else {
                println "LDAP server is already started."
            }
        }
    }
}

task stopLdapServer() {
    doLast {
        if (!Os.isFamily(Os.FAMILY_WINDOWS)) {
            def stdOut = new ByteArrayOutputStream()
            exec {
                commandLine 'sh', '-c', "docker ps --filter name=openldap-server"
                standardOutput = stdOut
            }
            if (stdOut.toString().contains("openldap-server")) {
                println "Stopping LDAP server."
                exec {
                    commandLine 'sh', '-c', "docker stop openldap-server"
                    standardOutput = stdOut
                }
                println stdOut.toString()
                println "Waiting 5s until the LDAP server get stopped."
                sleep(5 * 1000)
            } else {
                println "LDAP server is not started."
            }
        }
    }
}

task startRabbitmqServer() {
    doLast {
        if (!Os.isFamily(Os.FAMILY_WINDOWS)) {
            def stdOut = new ByteArrayOutputStream()
            exec {
                commandLine 'sh', '-c', "docker ps --filter name=my-rabbit"
                standardOutput = stdOut
            }
            if (!stdOut.toString().contains("my-rabbit")) {
                println "Starting RabbitMQ server."
                exec {
                    commandLine 'sh', '-c', "docker run --rm -d --name my-rabbit -p 15672:15672 -p  5672:5672 rabbitmq:3-management"
                    standardOutput = stdOut
                }
                println stdOut.toString()
                sleep(5 * 1000)
            } else {
                println "RabbitMQ server is already started."
            }
        }
    }
}

task stopRabbitmqServer() {
    doLast {
        if (!Os.isFamily(Os.FAMILY_WINDOWS)) {
            def stdOut = new ByteArrayOutputStream()
            exec {
                commandLine 'sh', '-c', "docker ps --filter name=my-rabbit"
                standardOutput = stdOut
            }
            if (stdOut.toString().contains("my-rabbit")) {
                println "Stopping RabbitMQ server."
                exec {
                    commandLine 'sh', '-c', "docker stop my-rabbit"
                    standardOutput = stdOut
                }
                println stdOut.toString()
                sleep(5 * 1000)
            } else {
                println "RabbitMQ server is not started."
            }
        }
    }
}

task startNatsServer() {
    doLast {
        if (!Os.isFamily(Os.FAMILY_WINDOWS)) {
            def stdOut = new ByteArrayOutputStream()
            exec {
                commandLine 'sh', '-c', "docker ps --filter name=my-nats"
                standardOutput = stdOut
            }
            if (!stdOut.toString().contains("my-nats")) {
                println "Starting NATS Basic server."
                exec {
                    commandLine 'sh', '-c', "docker run --rm -d --name my-nats -p 4222:4222 nats:latest"
                    standardOutput = stdOut
                }
                println stdOut.toString()
                sleep(5 * 1000)
            } else {
                println "NATS Basic server is already started."
            }
        }
    }
}

task stopNatsServer() {
    doLast {
        if (!Os.isFamily(Os.FAMILY_WINDOWS)) {
            def stdOut = new ByteArrayOutputStream()
            exec {
                commandLine 'sh', '-c', "docker ps --filter name=my-nats"
                standardOutput = stdOut
            }
            if (stdOut.toString().contains("my-nats")) {
                println "Stopping NATS server."
                exec {
                    commandLine 'sh', '-c', "docker stop my-nats"
                    standardOutput = stdOut
                }
                println stdOut.toString()
                sleep(5 * 1000)
            } else {
                println "NATS server is not started."
            }
        }
    }
}

/* Unpack Dependencies */
unpackJballerinaTools.dependsOn unpackBallerinaJre
unpackAzFunctionsBalo.dependsOn unpackJballerinaTools
unpackAzFunctionsExamples.dependsOn unpackAzFunctionsBalo
unpackAwsLambdaBalo.dependsOn unpackAzFunctionsExamples
unpackAwsLambdaExamples.dependsOn unpackAwsLambdaBalo
unpackDockerAnnotations.dependsOn unpackAwsLambdaExamples
unpackDockerExamples.dependsOn unpackDockerAnnotations
unpackKubernetesAnnotations.dependsOn unpackDockerExamples
unpackKubernetesExamples.dependsOn unpackKubernetesAnnotations
unpackStdLibs.dependsOn unpackKubernetesExamples
unpackC2cLibs.dependsOn unpackStdLibs
unpackBalCommand.dependsOn unpackC2cLibs

/* Extract JRE */
extractJreForLinux.dependsOn unpackBalCommand
extractJreForMac.dependsOn extractJreForLinux
extractJreForWindows.dependsOn extractJreForMac

copyOtherRepos.dependsOn extractJreForWindows
combineDocs.dependsOn copyOtherRepos
/* Package Distributions */
packageDist.dependsOn combineDocs
packageDistZip.dependsOn packageDist
packageDistLinux.dependsOn packageDistZip
packageDistMac.dependsOn packageDistLinux
packageDistWindows.dependsOn packageDistMac

testExamples.dependsOn packageDist

testStdlibs.dependsOn startLdapServer
testStdlibs.dependsOn startRabbitmqServer
testStdlibs.dependsOn startNatsServer
testStdlibs.dependsOn packageDist
testStdlibs.finalizedBy stopLdapServer
testStdlibs.finalizedBy stopRabbitmqServer
testStdlibs.finalizedBy stopNatsServer

testDevTools.dependsOn packageDist

/* Delete Temporary Files */
deleteTemporaryFiles.dependsOn packageDistWindows
deleteTemporaryFiles.dependsOn testExamples
deleteTemporaryFiles.dependsOn testStdlibs
deleteTemporaryFiles.dependsOn testDevTools
build.dependsOn deleteTemporaryFiles
